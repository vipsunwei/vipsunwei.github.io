import{_ as t}from"./chunks/ArticleMetadata.dd4bf5dc.js";import{_ as r,c,g as i,w as y,b as e,f as C,a as d,i as B,o,e as A,j as D}from"./app.960cb299.js";const m="/assets/202211042020211.5951b90c.png",x=JSON.parse('{"title":"解决 Docker 安装 Prometheus 启动报 permission denied 的问题","description":"","frontmatter":{"title":"解决 Docker 安装 Prometheus 启动报 permission denied 的问题","author":"查尔斯","date":"2022/11/04 20:30","categories":["Bug万象集"],"tags":["Prometheus","Docker","Linux"]},"headers":[{"level":2,"title":"问题描述","slug":"问题描述","link":"#问题描述","children":[]},{"level":2,"title":"原因分析","slug":"原因分析","link":"#原因分析","children":[]},{"level":2,"title":"解决方案","slug":"解决方案","link":"#解决方案","children":[]}],"relativePath":"categories/issues/2022/11/04/解决Docker安装Prometheus启动报错的问题.md","lastUpdated":1677831742000}'),F={name:"categories/issues/2022/11/04/解决Docker安装Prometheus启动报错的问题.md"},u=e("h1",{id:"解决-docker-安装-prometheus-启动报-permission-denied-的问题",tabindex:"-1"},[C("解决 Docker 安装 Prometheus 启动报 permission denied 的问题 "),e("a",{class:"header-anchor",href:"#解决-docker-安装-prometheus-启动报-permission-denied-的问题","aria-hidden":"true"},"#")],-1),h=d(`<h2 id="问题描述" tabindex="-1">问题描述 <a class="header-anchor" href="#问题描述" aria-hidden="true">#</a></h2><p><strong>C：</strong> 今天，笔者在使用 Docker 安装了 Prometheus 后，发现其容器没有能正常启动，而是处于持续重启的状态。笔者手动尝试了几次重启容器命令，依然如此。</p><p>遇到这种情况，单纯去盯容器运行命令哪里有错误，排查和修复就慢了，不如先看看 Prometheus 容器的日志。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># docker logs 容器ID/容器名称</span></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">logs</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">prometheus</span></span>
<span class="line"></span></code></pre><pre class="shiki one-dark-pro vp-code-light" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;"># docker logs 容器ID/容器名称</span></span>
<span class="line"><span style="color:#ABB2BF;">docker </span><span style="color:#98C379;">logs</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">prometheus</span></span>
<span class="line"></span></code></pre></div><p>在容器日志中，笔者看到了几段重复性的日志内容，很显然这是几次重启容器出现的重复性日志，笔者从中截取了一段相对完整的日志内容。</p><p><img src="`+m+`" alt="202211042020211"></p><p>错误信息部分也很突出，level=error。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">caller</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">query_logger.go:</span><span style="color:#F78C6C;">90</span><span style="color:#A6ACCD;"> level</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">error</span><span style="color:#A6ACCD;"> component</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">activeQueryTracker</span><span style="color:#A6ACCD;"> msg</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Error opening quer log file</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> file</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">/opt/bitnami/prometheus/data/queries.active</span><span style="color:#A6ACCD;"> err</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">open data/queries.active: permission denied</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#FFCB6B;">panic:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Unable</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">create</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mmap-ed</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">active</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">query</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">log</span></span>
<span class="line"></span></code></pre><pre class="shiki one-dark-pro vp-code-light" tabindex="0"><code><span class="line"><span style="color:#E06C75;">caller</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">query_logger.go:</span><span style="color:#D19A66;">90</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">level</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">error</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">component</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">activeQueryTracker</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">msg</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&quot;Error opening quer log file&quot;</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">file</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">/opt/bitnami/prometheus/data/queries.active</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">err</span><span style="color:#56B6C2;">=</span><span style="color:#98C379;">&quot;open data/queries.active: permission denied&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">panic: </span><span style="color:#98C379;">Unable</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">to</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">create</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">mmap-ed</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">active</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">query</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">log</span></span>
<span class="line"></span></code></pre></div><h2 id="原因分析" tabindex="-1">原因分析 <a class="header-anchor" href="#原因分析" aria-hidden="true">#</a></h2><p>简单翻译一下错误信息 msg 及后面部分提示。</p><blockquote><p>信息：打开查询日志文件时出错 file=/opt/bitnami/prometheus/data/queries.active 错误：打开 data/queries.active：拒绝访问</p></blockquote><p>其中的关键信息是 <code>permission denied</code>（拒绝访问），从这字面意思上可以得知和权限有关。</p><p>为了方便大家进行原因分析，笔者把 docker-compose 的 Prometheus 部分脚本贴在下方。</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#F07178;">version</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">3</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">services</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">prometheus</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">container_name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">prometheus</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bitnami/prometheus:2.38.0</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">restart</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">always</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">environment</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">TZ</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Asia/Shanghai</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">19090:9090</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">volumes</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/opt/disk/docker/volumes/prometheus/conf:/opt/bitnami/prometheus/conf</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/opt/disk/docker/volumes/prometheus/data:/opt/bitnami/prometheus/data</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C3E88D;">--config.file=/opt/bitnami/prometheus/conf/prometheus.yml</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C3E88D;">--web.enable-lifecycle</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C3E88D;">--storage.tsdb.retention.time=90d</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">privileged</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"></span></code></pre><pre class="shiki one-dark-pro vp-code-light" tabindex="0"><code><span class="line"><span style="color:#E06C75;">version</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">&#39;3&#39;</span></span>
<span class="line"><span style="color:#E06C75;">services</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;">prometheus</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">container_name</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">prometheus</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">image</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">bitnami/prometheus:2.38.0</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">restart</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">always</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">environment</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#E06C75;">TZ</span><span style="color:#ABB2BF;">: </span><span style="color:#98C379;">Asia/Shanghai</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">ports</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span style="color:#ABB2BF;">      - </span><span style="color:#98C379;">19090:9090</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">volumes</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span style="color:#ABB2BF;">      - </span><span style="color:#98C379;">/opt/disk/docker/volumes/prometheus/conf:/opt/bitnami/prometheus/conf</span></span>
<span class="line"><span style="color:#ABB2BF;">      - </span><span style="color:#98C379;">/opt/disk/docker/volumes/prometheus/data:/opt/bitnami/prometheus/data</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">command</span><span style="color:#ABB2BF;">:</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#98C379;">--config.file=/opt/bitnami/prometheus/conf/prometheus.yml</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#98C379;">--web.enable-lifecycle</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#98C379;">--storage.tsdb.retention.time=90d</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">privileged</span><span style="color:#ABB2BF;">: </span><span style="color:#D19A66;">true</span></span>
<span class="line"></span></code></pre></div><p>很明显，错误信息中的文件路径 <code>/opt/bitnami/prometheus/data/queries.active</code>，是 Prometheus 容器中的数据存储目录，笔者还将其挂载到了宿主机的 <code>/opt/disk/docker/volumes/prometheus/data</code> 目录。</p><p>关于脚本中的两个挂载目录，笔者仅提前创建了 conf 配置目录，上传了配置文件。至于这个 data 数据目录则是 Docker 在运行容器时自动在宿主机创建的。</p><p>那问题的原因已经呼之欲出了，很大可能是由于 Docker 在宿主机自动创建的 data 数据挂载目录没有写入权限。</p><h2 id="解决方案" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案" aria-hidden="true">#</a></h2><p>解决起来也较为容易，给 data 目录授予写入权限就好了。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">chmod</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">775</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/opt/disk/docker/volumes/prometheus/data</span></span>
<span class="line"></span></code></pre><pre class="shiki one-dark-pro vp-code-light" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">chmod </span><span style="color:#D19A66;">775</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">/opt/disk/docker/volumes/prometheus/data</span></span>
<span class="line"></span></code></pre></div><p>最后再重启一下 Prometheus 容器。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">restart</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">prometheus</span></span>
<span class="line"></span></code></pre><pre class="shiki one-dark-pro vp-code-light" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">docker </span><span style="color:#98C379;">restart</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">prometheus</span></span>
<span class="line"></span></code></pre></div><p>此时，再通过 <code>docker ps</code> 命令查看 Prometheus 容器的状态，已经是正常的 Up 状态了。最后，笔者也是建议大家这类挂载目录尽量提前创建和授权。</p>`,23);function g(s,k,v,E,_,b){const p=t,l=B("ClientOnly");return o(),c("div",null,[u,i(l,null,{default:y(()=>{var a,n;return[(((a=s.$frontmatter)==null?void 0:a.aside)??!0)&&(((n=s.$frontmatter)==null?void 0:n.showArticleMetadata)??!0)?(o(),A(p,{key:0,article:s.$frontmatter},null,8,["article"])):D("",!0)]}),_:1}),h])}const P=r(F,[["render",g]]);export{x as __pageData,P as default};
