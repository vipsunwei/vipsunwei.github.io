import{_ as t}from"./chunks/ArticleMetadata.dd4bf5dc.js";import{_ as i,c,g as r,w as d,b as e,f as g,a as u,i as x,o,e as b,j as y}from"./app.960cb299.js";const C="/assets/202209052140666.e5f9c09b.png",h="/assets/202209052232777.35f54193.png",E=JSON.parse('{"title":"Nginx转发请求，报13：Permission denied错误","description":"","frontmatter":{"title":"Nginx转发请求，报13：Permission denied错误","author":"查尔斯","date":"2022/09/05 21:44","categories":["Bug万象集"],"tags":["Linux","Nginx"]},"headers":[{"level":2,"title":"问题描述","slug":"问题描述","link":"#问题描述","children":[]},{"level":2,"title":"原因分析","slug":"原因分析","link":"#原因分析","children":[]},{"level":2,"title":"解决方案","slug":"解决方案","link":"#解决方案","children":[]},{"level":2,"title":"参考资料","slug":"参考资料","link":"#参考资料","children":[]}],"relativePath":"categories/issues/2022/09/05/Nginx转发请求，报13：Permission denied错误.md","lastUpdated":1677831742000}'),A={name:"categories/issues/2022/09/05/Nginx转发请求，报13：Permission denied错误.md"},f=e("h1",{id:"nginx转发请求-报13-permission-denied错误",tabindex:"-1"},[g("Nginx转发请求，报13：Permission denied错误 "),e("a",{class:"header-anchor",href:"#nginx转发请求-报13-permission-denied错误","aria-hidden":"true"},"#")],-1),m=u(`<h2 id="问题描述" tabindex="-1">问题描述 <a class="header-anchor" href="#问题描述" aria-hidden="true">#</a></h2><p><strong>C：</strong> 上周五下班前刚给新项目的测试环境添加上了 CI/CD，本以为事情就告一段落了，今天上午前端小伙伴合并了一版到测试环境，然后测试小伙伴就在群里 @ 笔者，问登录验证码怎么出不来了。</p><p>赶紧去测试地址看了一下，发现验证码接口 Nginx 502 了，首先想到的就是后端服务宕了，登上测试环境看了看，人家跑得欢快的很啊，程序日志里也没出现什么错误。</p><div class="tip custom-block"><p class="custom-block-title">笔者说</p><p>HTTP 状态码 502：表示作为网关或代理角色的服务器，从上游服务器（如tomcat、php-fpm）中接收到的响应是无效的。</p></div><p>既然错误不在后端服务，那就顺着调用链路往前排查看看，打开 Nginx 错误日志，看看究竟是什么原因导致的 502。</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/log/nginx/</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 查看错误日志</span></span>
<span class="line"><span style="color:#FFCB6B;">tail</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-50</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">error.log</span></span>
<span class="line"></span></code></pre><pre class="shiki one-dark-pro vp-code-light" tabindex="0"><code><span class="line"><span style="color:#56B6C2;">cd</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">/var/log/nginx/</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 查看错误日志</span></span>
<span class="line"><span style="color:#ABB2BF;">tail </span><span style="color:#D19A66;">-50</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">error.log</span></span>
<span class="line"></span></code></pre></div><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">2022/09/05 10:03:47 [crit] 8431#8431: *45 connect() to 127.0.0.1:18005 failed (13: Permission denied) while connecting to upstream, client: xx.xxx.xx.xxx, server: _, request: &quot;GET /api/captcha?_t=1662344535439 HTTP/1.1&quot;, upstream: &quot;http://127.0.0.1:18005/captcha?_t=1662344535439&quot;, host: &quot;xx.x.xxx.xx&quot;, referrer: &quot;http://xx.x.xxx.xx/&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><pre class="shiki one-dark-pro vp-code-light" tabindex="0"><code><span class="line"><span style="color:#abb2bf;">2022/09/05 10:03:47 [crit] 8431#8431: *45 connect() to 127.0.0.1:18005 failed (13: Permission denied) while connecting to upstream, client: xx.xxx.xx.xxx, server: _, request: &quot;GET /api/captcha?_t=1662344535439 HTTP/1.1&quot;, upstream: &quot;http://127.0.0.1:18005/captcha?_t=1662344535439&quot;, host: &quot;xx.x.xxx.xx&quot;, referrer: &quot;http://xx.x.xxx.xx/&quot;</span></span>
<span class="line"><span style="color:#abb2bf;"></span></span></code></pre></div><p><img src="`+C+`" alt="202208112010100"></p><h2 id="原因分析" tabindex="-1">原因分析 <a class="header-anchor" href="#原因分析" aria-hidden="true">#</a></h2><p>抓住错误关键词 <code>Permission denied</code>，没有权限的意思，笔者突然灵光一现，很早以前安装 Nginx，在启动的时候遇到过一个和权限类似的错误，大意是你不能用 <code>root</code> 直接启动。 Nginx 配置文件中有一个 <code>user</code> 配置，启动 Nginx 需要用对应的用户才能启动，笔者现在是登录的 <code>root</code> 用户，今天 CI/CD 执行后出现这问题了，还是得去确认下 Nginx 配置。</p><div class="tip custom-block"><p class="custom-block-title">笔者说</p><p>这个 Nginx 是上周五让网管装的，代理部分配置也是直接复制的另一个项目的发给他就配上了，配完笔者直接用上了，当时手动打包前端传上来也没见出现什么问题。</p></div><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;"># For more information on configuration, see:</span></span>
<span class="line"><span style="color:#A6ACCD;">#   * Official English Documentation: http://nginx.org/en/docs/</span></span>
<span class="line"><span style="color:#A6ACCD;">#   * Official Russian Documentation: http://nginx.org/ru/docs/</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">user nginx;</span></span>
<span class="line"><span style="color:#A6ACCD;">worker_processes auto;</span></span>
<span class="line"><span style="color:#A6ACCD;">error_log /var/log/nginx/error.log;</span></span>
<span class="line"><span style="color:#A6ACCD;">pid /run/nginx.pid;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">....</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><pre class="shiki one-dark-pro vp-code-light" tabindex="0"><code><span class="line"><span style="color:#abb2bf;"># For more information on configuration, see:</span></span>
<span class="line"><span style="color:#abb2bf;">#   * Official English Documentation: http://nginx.org/en/docs/</span></span>
<span class="line"><span style="color:#abb2bf;">#   * Official Russian Documentation: http://nginx.org/ru/docs/</span></span>
<span class="line"><span style="color:#abb2bf;"></span></span>
<span class="line"><span style="color:#abb2bf;">user nginx;</span></span>
<span class="line"><span style="color:#abb2bf;">worker_processes auto;</span></span>
<span class="line"><span style="color:#abb2bf;">error_log /var/log/nginx/error.log;</span></span>
<span class="line"><span style="color:#abb2bf;">pid /run/nginx.pid;</span></span>
<span class="line"><span style="color:#abb2bf;"></span></span>
<span class="line"><span style="color:#abb2bf;">....</span></span>
<span class="line"><span style="color:#abb2bf;"></span></span></code></pre></div><h2 id="解决方案" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案" aria-hidden="true">#</a></h2><p>赶紧改一下，重新加载下配置试试。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;"># For more information on configuration, see:</span></span>
<span class="line"><span style="color:#A6ACCD;">#   * Official English Documentation: http://nginx.org/en/docs/</span></span>
<span class="line"><span style="color:#A6ACCD;">#   * Official Russian Documentation: http://nginx.org/ru/docs/</span></span>
<span class="line"><span style="color:#A6ACCD;"># 将 user 配置改为 root</span></span>
<span class="line"><span style="color:#A6ACCD;">user root;</span></span>
<span class="line"><span style="color:#A6ACCD;">worker_processes auto;</span></span>
<span class="line"><span style="color:#A6ACCD;">error_log /var/log/nginx/error.log;</span></span>
<span class="line"><span style="color:#A6ACCD;">pid /run/nginx.pid;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">....</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><pre class="shiki one-dark-pro vp-code-light" tabindex="0"><code><span class="line"><span style="color:#abb2bf;"># For more information on configuration, see:</span></span>
<span class="line"><span style="color:#abb2bf;">#   * Official English Documentation: http://nginx.org/en/docs/</span></span>
<span class="line"><span style="color:#abb2bf;">#   * Official Russian Documentation: http://nginx.org/ru/docs/</span></span>
<span class="line"><span style="color:#abb2bf;"># 将 user 配置改为 root</span></span>
<span class="line"><span style="color:#abb2bf;">user root;</span></span>
<span class="line"><span style="color:#abb2bf;">worker_processes auto;</span></span>
<span class="line"><span style="color:#abb2bf;">error_log /var/log/nginx/error.log;</span></span>
<span class="line"><span style="color:#abb2bf;">pid /run/nginx.pid;</span></span>
<span class="line"><span style="color:#abb2bf;"></span></span>
<span class="line"><span style="color:#abb2bf;">....</span></span>
<span class="line"><span style="color:#abb2bf;"></span></span></code></pre></div><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-s</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">reload</span></span>
<span class="line"></span></code></pre><pre class="shiki one-dark-pro vp-code-light" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">nginx </span><span style="color:#D19A66;">-s</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">reload</span></span>
<span class="line"></span></code></pre></div><p>问题没解决，还是 502，这可就触碰到笔者的知识盲区了，搜索一下吧，实在不行问问网管。</p><p>这一搜啊，有一个搜索结果摘要引起了笔者的注意：</p><blockquote><p><strong>解决SELinux阻止Nginx访问服务</strong></p><p>“在使用 yum 安装 nginx 后可能会出现配置完成后却无法访问的问题”。[1]</p></blockquote><p>笔者这一想，我们公司的网管当时让他安装 Nginx 没 5 分钟就告诉 OK 了，那很大可能是用 yum 安装的啊，作者博客让看一下 audit.log 有没有出现错误信息，笔者前去看了一下</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">tail</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-50</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/log/audit/audit.log</span></span>
<span class="line"></span></code></pre><pre class="shiki one-dark-pro vp-code-light" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">tail </span><span style="color:#D19A66;">-50</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">/var/log/audit/audit.log</span></span>
<span class="line"></span></code></pre></div><p>果然和作者贴的图一模一样。</p><p><img src="`+h+`" alt="202209052232777"></p><blockquote><p>根据作者所言，&quot;出现此问题的原因是 SELinux 基于最小权限原则默认拦截了 Nginx 的请求，SELinux 是 Linux 的安全子系统，提供更安全的访问控制。&quot;[1]</p></blockquote><p>解决方法，要么是直接关掉它，要么执行下方指令开启 HTTP 访问。</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code-dark" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">setsebool</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-P</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">httpd_can_network_connect</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"></span></code></pre><pre class="shiki one-dark-pro vp-code-light" tabindex="0"><code><span class="line"><span style="color:#ABB2BF;">setsebool </span><span style="color:#D19A66;">-P</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">httpd_can_network_connect</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">1</span></span>
<span class="line"></span></code></pre></div><p>执行后，立竿见影。忍不住感叹：Linux 知识学无止境。</p><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-hidden="true">#</a></h2><p>[1]解决SELinux阻止Nginx访问服务：<a href="https://blog.csdn.net/liweitao7610/article/details/107073852" target="_blank" rel="noreferrer">https://blog.csdn.net/liweitao7610/article/details/107073852</a></p>`,29);function _(s,D,k,v,B,F){const l=t,p=x("ClientOnly");return o(),c("div",null,[f,r(p,null,{default:d(()=>{var n,a;return[(((n=s.$frontmatter)==null?void 0:n.aside)??!0)&&(((a=s.$frontmatter)==null?void 0:a.showArticleMetadata)??!0)?(o(),b(l,{key:0,article:s.$frontmatter},null,8,["article"])):y("",!0)]}),_:1}),m])}const P=i(A,[["render",_]]);export{E as __pageData,P as default};
